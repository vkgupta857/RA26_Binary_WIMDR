{% extends 'base.html' %}

{% block head %}
<script src="https://maps.google.com/maps/api/js?key=AIzaSyBIZzJADy9kDwosxnQrILpgK00dZvIPgYM"></script>
<script src="/static/js/jquery-3.3.1.min.js"></script>
{% endblock %}
{% block body %}
<!-- Navigation -->
<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-light top-nav fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/index">
            <img src="/static/images/logo.png" alt="logo" /><a style="color: #4e3914;">
                <h3>Waste Management</h3>
            </a>
        </a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
            data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="fas fa-bars"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/index">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/login">Login</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="container">
    <br class="my-2">
    <h4 class="text-center">Category-wise Wastes reported</h4>
    <p class="text-center">
        <b>Legends - </b>
        ALERT: <img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png" height="20" class="mr-4" />
        HIGH WASTE:<img src="http://maps.google.com/mapfiles/ms/icons/orange-dot.png" height="20" class="mr-4" />
        MEDIUM WASTE:<img src="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png" height="20" class="mr-4" />
        LOW WASTE:<img src="http://maps.google.com/mapfiles/ms/icons/purple-dot.png" height="20" class="mr-4" />
    </p>
    <div class="card text-center">
        <div class="card-body">
            <div id="mapHolder"> <span class="spinner-border text-success"></span> Fetching data...</div>
        </div>
    </div>
    <hr class="my-4 bg-dark">
    <h4 class="text-center">False/Frequent (Anomalies) Reports</h4>
    <p class="text-center">
        <b>Legends - </b>
        
        Reporting daily for 3 days: <img src="/static/images/marker-blue.png" height="20" />
    </p>
    <div class="card text-center">
        <div class="card-body">
            <div id="anomalyMapHolder"> <span class="spinner-border text-success"></span> Fetching data...</div>
        </div>
    </div>
    <hr class="bg-dark my-4">
    <div class="text-center">
        <a href="/ClustermapM?city={{city}}&state={{state}}"><button class="btn btn-success">View Cluster Map</button></a>
    </div>
    <br>
</div>

<script>
    var mapholder = document.getElementById('mapHolder');

    var iconBase =
        'http://maps.google.com/mapfiles/ms/icons/';

    var icons = {
        Late: {
            icon: iconBase + 'red-dot.png'
        },
        H: {
            icon: iconBase + 'orange-dot.png'
        },
        M: {
            icon: iconBase + 'yellow-dot.png'
        },
        L: {
            icon: iconBase + 'purple-dot.png'
        }
    };

    // var features = Array;

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const city = urlParams.get('city');
    const state = urlParams.get('state');

    $.ajax({
        url: '/map',
        type: 'POST',
        data: {
            city: city,
            state: state
        },
        success: function (res) {
            // console.log(res);
            var pointsToShow = res.points;

            if (pointsToShow.length == 0) {
                document.getElementById('mapHolder').innerHTML = "<h3>Yay! No wastes in " + city + "</h3><p>Hence, cannot plot on map</p>";
            } else {
                var lat = pointsToShow[0]['lattitude'];
                var lon = pointsToShow[0]['longitude'];
                var latlon = new google.maps.LatLng(lat, lon)

                mapholder.style.height = '400px';
                mapholder.style.width = '100%';
                var myOptions = {
                    center: latlon,
                    zoom: 12,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    mapTypeControl: false,
                    navigationControlOptions: { style: google.maps.NavigationControlStyle.SMALL }
                };

                var map = new google.maps.Map(document.getElementById('mapHolder'), myOptions);

                for (var point of pointsToShow) {
                    var lat = point.lattitude;
                    // lattitude spelling is defined in db. dont change
                    var lng = point.longitude;
                    var type = point.status;
                    // console.log(lat, lng, type);

                    var marker = new google.maps.Marker({
                        position: new google.maps.LatLng(lat, lng),
                        icon: icons[type].icon,
                        map: map,
                        title: type
                    });

                    if (type == 'Late') {
                        marker.setAnimation(google.maps.Animation.BOUNCE);
                    }
                }
            }

            // AnomalyMap starts here

            var anomalyPoints = res.anomaly;
            console.log(anomalyPoints);

            if (anomalyPoints.length == 0) {
                document.getElementById('anomalyMapHolder').innerHTML = "<p>No anomalies detected.</p>";
                console.log("No anomalies!");
            } else {
                var lat = anomalyPoints[0][0];
                var lon = anomalyPoints[0][1];
                // console.log("ahc",lat,lon);
                var latlon = new google.maps.LatLng(lat, lon);

                console.log("mapCenter",latlon);

                var anomalyMapHolder = document.getElementById("anomalyMapHolder");

                anomalyMapHolder.style.height = '400px';
                anomalyMapHolder.style.width = '100%';
                var anomalyOptions = {
                    center: latlon,
                    zoom: 12,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    mapTypeControl: false,
                    navigationControlOptions: { style: google.maps.NavigationControlStyle.SMALL }
                };

                var anomalyMap = new google.maps.Map(document.getElementById('anomalyMapHolder'), anomalyOptions);

                for (var point of anomalyPoints) {
                    var lat = point[0];
                    var lng = point[1];

                    console.log(lat, lng);

                    var marker = new google.maps.Marker({
                        position: new google.maps.LatLng(lat, lng),
                        icon: '/static/images/marker-blue.png',
                        map: anomalyMap,
                        title: "Anomaly"
                    });
                    marker.setAnimation(google.maps.Animation.BOUNCE);
                }
            }
        },
        error: function (xhr) {
            console.log("Error", xhr.status, xhr.statusText);
        }
    });

</script>

{% endblock %}
