{% extends 'base.html' %}

{% block head %}
<script src="https://maps.google.com/maps/api/js?key=AIzaSyBIZzJADy9kDwosxnQrILpgK00dZvIPgYM"></script>
<script src="/static/js/jquery-3.3.1.min.js"></script>
{% endblock %}
{% block body %}
<!-- Navigation -->
<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-light top-nav fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/index">
            <img src="/static/images/logo.png" alt="logo" /><a style="color: #4e3914;">
                <h3>Waste Management</h3>
            </a>
        </a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
            data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="fas fa-bars"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/index">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/login">Login</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="container">
    <br class="my-2">
    <h4 class="text-center">Category-wise Wastes reported</h4>
    <p class="text-center">
        <b>Legends - </b>
        ALERT: <img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png" height="20" class="mr-4" />
        HIGH WASTE:<img src="http://maps.google.com/mapfiles/ms/icons/orange-dot.png" height="20" class="mr-4" />
        MEDIUM WASTE:<img src="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png" height="20" class="mr-4" />
        LOW WASTE:<img src="http://maps.google.com/mapfiles/ms/icons/purple-dot.png" height="20" class="mr-4" />
    </p>
    <div class="card text-center">
        <div class="card-body">
            <div id="mapHolder"> <span class="spinner-border text-success"></span> Fetching data...</div>
        </div>
    </div>
    <hr class="my-4 bg-dark">
    <h4 class="text-center">False/Frequent (Anomalies) Reports</h4>
    <p class="text-center">
        <b>Legends - </b>
        
        Reporting daily for 3 days: <img src="/static/images/blue.png" height="20" />
    </p>
    <div class="card text-center">
        <div class="card-body">
            <div id="UnusualActivityMap"> <span class="spinner-border text-success"></span> Fetching data...</div>
        </div>
    </div>
    <br>
    <div class="text-center">
        <a href="/ClustermapM?city={{city}}&state={{state}}"><button class="btn btn-success">View Cluster Map</button></a>
    </div>
    <br>
</div>

<script>
    var mapholder = document.getElementById('mapHolder');

    var iconBase =
        'http://maps.google.com/mapfiles/ms/icons/';

    var icons = {
        Late: {
            icon: iconBase + 'red-dot.png'
        },
        H: {
            icon: iconBase + 'orange-dot.png'
        },
        M: {
            icon: iconBase + 'yellow-dot.png'
        },
        L: {
            icon: iconBase + 'purple-dot.png'
        }
    };

    // var features = Array;

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const city = urlParams.get('city');
    const state = urlParams.get('state');

    $.ajax({
        url: '/map',
        type: 'POST',
        data: {
            city: city,
            state: state
        },
        success: function (res) {
            // console.log(res);
            var pointsToShow = res.points;
            console.log(pointsToShow);

            if (pointsToShow.length <= 0) {
                // alert("Voila! No waste in the city.");
                document.getElementById('mapHolder').innerHTML = "<h3>Yay! No wastes in " + city + "</h3><p>Hence, cannot plot on map</p>";
            }
            var lat = pointsToShow[0]['lattitude'];
            var lon = pointsToShow[0]['longitude'];
            var latlon = new google.maps.LatLng(lat, lon)

            mapholder.style.height = '400px';
            mapholder.style.width = '100%';
            var myOptions = {
                center: latlon,
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: false,
                navigationControlOptions: { style: google.maps.NavigationControlStyle.SMALL }
            };

            var map = new google.maps.Map(document.getElementById('mapHolder'), myOptions);

            for (var point of pointsToShow) {
                var lat = point.lattitude;
                // lattitude spelling is defined in db. dont change
                var lng = point.longitude;
                var type = point.status;
                // console.log(lat, lng, type);

                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(lat, lng),
                    icon: icons[type].icon,
                    map: map
                });

                if (type == 'Late') {
                    marker.setAnimation(google.maps.Animation.BOUNCE);
                }
            }

            // AnomalyMap statrs here

            var activityPts = [
                {
                    position: new google.maps.LatLng(23.1369307508016, 79.9414282743248),
                    type: 'Anamolytoday'
                }, {
                    position: new google.maps.LatLng(23.1727464960143, 79.9910974486153),
                    type: 'Anamolytoday'
                }, {
                    position: new google.maps.LatLng(23.1486192051069, 80.0026714942545),
                    type: 'Anamoly'
                }, {
                    position: new google.maps.LatLng(23.1531149888702, 79.9342859487367),
                    type: 'Anamolytoday'
                }, {
                    position: new google.maps.LatLng(23.1167438348741, 79.9520082160492),
                    type: 'Anamoly'
                }, {
                    position: new google.maps.LatLng(23.1889701697534, 79.9194404400441),
                    type: 'Anamolytoday'
                }, {
                    position: new google.maps.LatLng(23.2318370186875, 80.0006429944103),
                    type: 'Anamolytoday'
                }, {
                    position: new google.maps.LatLng(23.1673166117458, 79.9199472512678),
                    type: 'Anamolytoday'

                }, {
                    position: new google.maps.LatLng(23.1598206580546, 79.9530009019027),
                    type: 'Anamoly'
                }, {
                    position: new google.maps.LatLng(23.148966713523, 79.9250629976011),
                    type: 'Anamolytoday'
                }, {
                    position: new google.maps.LatLng(23.1489922123079, 79.9328874032764),
                    type: 'Anamoly'
                },
                {
                    position: new google.maps.LatLng(23.187380568543, 80.0008778100509),
                    type: 'Anamoly'
                }
            ];

            var ActivityMap = document.getElementById("UnusualActivityMap");
            var Activityicon = {
                Anamoly: {
                    icon: '/static/images/darkblue.png'
                },
                Anamolytoday: {
                    icon: '/static/images/blue.png'
                }
            };
            ActivityMap.style.height = '400px';
            ActivityMap.style.width = '100%';
            var anomalyOptions = {
                center: new google.maps.LatLng(23.187380568543, 80.0008778100509),
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: false,
                navigationControlOptions: { style: google.maps.NavigationControlStyle.SMALL }
            };

            var anomalyMap = new google.maps.Map(document.getElementById('UnusualActivityMap'), anomalyOptions);

            for (var i = 0; i < activityPts.length; i++) {
                var marker = new google.maps.Marker({
                    position: activityPts[i].position,
                    icon: Activityicon[activityPts[i].type].icon,
                    map: map
                });
                console.log(activityPts[i]);
                if (activityPts[i].type == 'Anamolytoday') {
                    var radius = 800;
                    var position = marker.getPosition();
                    var circle = new google.maps.Circle({
                        center: position,
                        radius: radius,
                        fillColor: "#00ace6",
                        fillOpacity: 0.3,
                        map: map,
                        strokeColor: "#00ace6",
                        strokeOpacity: 0.3,
                        strokeWeight: 2
                    });
                }

                if (activityPts[i].type == 'Anamoly') {
                    var radius = 800;
                    var position = marker.getPosition();
                    var circle = new google.maps.Circle({
                        center: position,
                        radius: radius,
                        fillColor: "#000066",
                        fillOpacity: 0.3,
                        map: map,
                        strokeColor: "#000066",
                        strokeOpacity: 0.3,
                        strokeWeight: 2
                    });
                }

            }
        },
        error: function (xhr) {
            console.log("Error", xhr.status, xhr.statusText);
        }
    });

</script>

{% endblock %}
